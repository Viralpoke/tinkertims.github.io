<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Skelly BLE Controller (Web Bluetooth)</title>
  <link rel="stylesheet" href="style.css">

  <script defer src="https://cdn.jsdelivr.net/npm/lamejs@1.2.1/lame.min.js"></script>
</head>
<body>
  <!-- First-load warning -->
  <div id="riskModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="riskTitle">
    <div class="modal-panel">
      <h3 id="riskTitle">‚ö†Ô∏è Proceed at your own risk</h3>
      <p>This tool talks directly to your skeleton over Bluetooth and can send file and control commands. While many features have been tested, there is <strong>NO GUARANTEE</strong> this won‚Äôt misbehave or damage your device. By continuing, you accept all risk.</p>
      <p class="muted">Use a fully charged device, keep the browser tab focused during transfers, and avoid interrupting power.</p>
      <div class="modal-actions">
        <button id="riskCancel" class="btn">Leave page</button>
        <button id="riskAccept" class="btn danger">I understand ‚Äî continue</button>
      </div>
    </div>
  </div>

<!-- Experimental Edit warning -->
<div id="editWarnModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="editWarnTitle">
  <div class="modal-panel" style="background:#101318;border-color:#273449;color:#e5e7eb;">
    <h3 id="editWarnTitle">Experimental feature</h3>
    <p>Per-file Edit actions are experimental and not all features have been tested. Proceed with caution.</p>
    <div class="modal-actions">
      <button id="editWarnOk" class="btn primary">OK</button>
    </div>
  </div>
</div>


  <!-- Slow upload heads-up -->
  <div id="slowModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="slowTitle">
    <div class="modal-panel" style="background:#101318;border-color:#273449;color:#e5e7eb;">
      <h3 id="slowTitle">Heads up: File sending can be slow</h3>
      <p>
        Large transfers over Bluetooth can take a while. After the file finishes uploading,
        the device may take a couple minutes before you see the final ‚Äúcomplete‚Äù message. 
        Converting the file can greatly speed up the process.
      </p>
      <p class="muted" style="margin-top:6px">
        Keep this tab focused and avoid disconnecting power during the process.
      </p>
      <label class="small checkline mt-10">
        <input id="slowDontShow" type="checkbox"> Don‚Äôt show this again
      </label>
      <div class="modal-actions">
        <button id="slowCancel" class="btn">Cancel</button>
        <button id="slowOk" class="btn primary">Continue</button>
      </div>
    </div>
</div>

<!-- Long track heads-up -->
<div id="longModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="longTitle">
  <div class="modal-panel" style="background:#101318;border-color:#273449;color:#e5e7eb;">
    <h3 id="longTitle">Heads up: long audio</h3>
    <p>
      Uploading tracks longer than 30 seconds is experimental and may be unreliable.
      You can still proceed, but results aren‚Äôt guaranteed.
    </p>
    <label class="small checkline" style="margin-top:10px">
      <input id="longDontShow" type="checkbox"> Don‚Äôt show this again
    </label>
    <div class="modal-actions">
      <button id="longOk" class="btn primary">OK</button>
    </div>
  </div>
</div>

  <!-- Edit file modal -->
  <div id="editModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="editTitle">
    <div class="modal-panel" style="background:#101318;border-color:#273449;color:#e5e7eb;">
      <h3 id="editTitle">Edit File</h3>
      <div class="row">
        <div>
          <label>Serial #</label>
          <input id="edSerial" disabled>
        </div>
        <div>
          <label>Cluster</label>
          <input id="edCluster" type="number" min="0" step="1">
        </div>
      </div>
      <div class="row">
        <div>
          <label>Action (0‚Äì255)</label>
          <input id="edAction" type="number" min="0" max="255" value="255">
        </div>
        <div>
          <label style="margin-top:12px">Eye Icon</label>
          <div id="eyeGrid" class="eye-grid" aria-label="Choose eye icon"></div>
        </div>
      </div>
      <!-- Movement (Per-file) -->
      <div class="spacer"></div>
      <label>Movement</label>
      <div id="edMove" class="move-grid">
        <button class="iconToggle" data-part="all"   title="All">
          <img src="images/icon_action1_se.png" alt="All" />
        </button>
        <button class="iconToggle" data-part="head"  title="Head">
          <img src="images/icon_action2_se.png" alt="Head" />
        </button>
        <button class="iconToggle" data-part="arm"   title="Arm">
          <img src="images/icon_action3_se.png" alt="Arm" />
        </button>
        <button class="iconToggle" data-part="torso" title="Torso">
          <img src="images/icon_action4_se.png" alt="Torso" />
        </button>
      </div>
      <button class="btn" id="applyEdMove">Apply Movement</button>


      <div class="spacer"></div>
      <label>Lighting Type</label>
      <div class="row">
        <select id="edLightMode" aria-label="Lighting type">
          <option value="1">Static</option>
          <option value="2">Strobe</option>
          <option value="3">Pulsing</option>
        </select>
        <button class="btn" id="edApplyMode">Apply Mode (F2)</button>
      </div>

      <div class="spacer"></div>
      <div id="edSpeedBlock">
        <label>Speed (0‚Äì255)</label>
        <div class="row">
          <input id="edSpeedRange" type="range" min="0" max="255" value="0" />
          <input id="edSpeed" type="number" min="0" max="255" value="0" />
          <button class="btn" id="edApplySpeed">Set Speed (F6)</button>
        </div>
      </div>

    <div class="spacer"></div>
    <label>Color (this file only)</label>
    <div class="row">
      <input id="edColorPick" type="color" value="#ff0000" />
      <input id="edR" type="number" min="0" max="255" value="255" />
      <input id="edG" type="number" min="0" max="255" value="0" />
      <input id="edB" type="number" min="0" max="255" value="0" />
      <button class="btn" id="edApplyRGB">Set Color (F4)</button>
    </div>

    <div class="spacer"></div>
    <label>Color presets</label>
    <div class="actions">
      <button class="iconToggle" id="edColorCycle" title="Cycle all colors (this file only)">
        <img src="images/icon_light_cycle_no.png" alt="Cycle colors" />
      </button>
      <span class="small muted">Cycles all colors for <strong>this file only</strong></span>
    </div>



      <label>File name</label>
      <input id="edName" placeholder="example.mp3">
      <div class="spacer"></div>
      <label>Upload new file (replace)</label>
      <input id="edUploadFile" type="file" />
      <label class="small checkline mt-8">
        <input id="edChkConvert" type="checkbox">
        Convert to device format (MP3, 8 kHz mono)
      </label>
      <div id="edConvertOpts" class="row hidden" style="align-items:center">
        <select id="edMp3Kbps" aria-label="MP3 bitrate (edit)">
          <option value="16">16 kbps</option>
          <option value="24">24 kbps</option>
          <option value="32" selected>32 kbps</option>
        </select>
        <span class="small muted">Converts input before uploading.</span>
      </div>

      <div class="actions">
        <button class="btn primary" id="edUploadBtn">Upload & Replace</button>
        <span class="small muted" id="edUploadProg">No upload</span>
      </div>
      <div class="modal-actions">
        <button id="edDelete" class="btn danger">Delete (C7)</button>
        <button id="edApplyEye" class="btn">Set Eye (F9)</button>
        <button id="edApplyAnim" class="btn primary">Set Animation (CA)</button>
        <button id="edClose" class="btn">Close</button>
      </div>
    </div>
  </div>

  <header>
    <h1>ü¶¥ Skelly BLE Controller</h1>
    <div class="topbar-right">
      <span id="status" class="pill">‚óè <span>Disconnected</span></span>
      <button class="btn primary" id="btnConnect">Connect</button>
      <button class="btn danger" id="btnDisconnect" disabled>Disconnect</button>
      <div class="menuwrap">
        <button class="btn" id="btnAdvanced">‚öôÔ∏è Advanced ‚ñæ</button>
        <div id="advMenu" class="dropdown hidden" role="menu" aria-label="Advanced options">
          <label><input type="checkbox" id="advRaw"> Show ‚ÄúRaw Command‚Äù</label>
          <label><input type="checkbox" id="advFT"> Show ‚ÄúFile Transfer‚Äù</label>
          <label><input type="checkbox" id="advFEDC"> Show FEDC keepalives</label>
          <label><input type="checkbox" id="advEdit"> Enable per-file Edit (experimental)</label>
        </div>
      </div>
      <form class="donate" action="https://www.paypal.com/donate" method="post" target="_top" aria-label="Donate">
        <input type="hidden" name="hosted_button_id" value="KHHJNFJMU3G6G" />
        <button type="submit" class="btn paypal" title="Support development">
          <span class="pp" aria-hidden="true"></span>
          <span class="txt">Donate</span>
        </button>

        <!-- Fallback (kept, but hidden by CSS) -->
        <input type="image"
              src="https://www.paypalobjects.com/en_US/i/btn/btn_donate_LG.gif"
              name="submit" alt="Donate" />
        <img alt="" src="https://www.paypal.com/en_US/i/scr/pixel.gif" width="1" height="1" />
      </form>

    </div>
  </header>

  <div class="grid">
    <!-- LEFT COL: Device / Commands -->
    <section class="card area-dev">
      <h2>Device / Commands</h2>

      <label>Filter by name (optional)</label>
      <input id="nameFilter" placeholder="Animated Skelly" value="Animated Skelly" />

      <div class="spacer"></div>
      <div>
        <label>Queries</label>
        <div class="actions">
          <button class="btn cmd" data-q="E0" data-code="E0">Get Device Params</button>
          <button class="btn cmd" data-q="E1" data-code="E1">Get Live Mode</button>
          <button class="btn cmd" data-q="E5" data-code="E5">Get Volume</button>
          <button class="btn cmd" data-q="E6" data-code="E6">Get BT Name</button>
          <button class="btn cmd" data-q="EE" data-code="EE">Get Version</button>
          <button class="btn cmd" data-q="D2" data-code="D2">Get Capacity</button>
        </div>

      </div>

      <!-- Raw Command (advanced) -->
      <div class="spacer"></div>
      <div id="advRawBlock" class="hidden">
        <label>Raw Command (hex after AA+TAG+payload[‚â§8B]+CRC8 auto)</label>
        <div class="row">
          <select id="tag">
            <option value="E0">E0</option><option value="E1">E1</option><option value="E5">E5</option>
            <option value="E6">E6</option><option value="EE">EE</option>
            <option value="D0">D0</option><option value="D1">D1</option><option value="D2">D2</option>
            <option value="FA">FA (Set Volume)</option><option value="FC">FC (Play/Pause)</option>
            <option value="FD">FD</option><option value="FE">FE</option><option value="F2">F2</option>
            <option value="F3">F3</option><option value="F4">F4</option><option value="F5">F5</option>
            <option value="F6">F6</option><option value="F9">F9</option>
            <option value="C0">C0</option><option value="C1">C1</option><option value="C2">C2</option>
            <option value="C3">C3</option><option value="C4">C4</option><option value="C6">C6</option>
            <option value="C7">C7</option><option value="C8">C8</option><option value="C9">C9</option>
            <option value="CA">CA</option><option value="CB">CB</option><option value="CC">CC</option>
          </select>
          <input id="payload" placeholder="payload hex (optional)" />
        </div>
        <div class="actions"><button class="btn" id="btnSendRaw">Send</button></div>
        <div class="small muted" style="margin-top:6px">Payload auto-pads to <strong>16 hex chars (8 bytes)</strong> before CRC8 (poly 0x8C).</div>
      </div>
      
    </section>

    <!-- MIDDLE COL: Media (top) -->
    <section class="card area-media">
      <h2>Media</h2>
      <div class="actions">
        <button class="btn" id="btnPlay">Play</button>
        <button class="btn" id="btnPause">Pause</button>
        <button class="btn" id="btnBT">Enable Classic BT (Live Mode)</button>
      </div>

      <!-- Volume (moved here) -->
      <div class="spacer"></div>
      <div>
        <label>Volume (0‚Äì100%)</label>
        <div class="row">
          <input id="volRange" type="range" min="0" max="100" value="50" />
          <input id="vol" type="number" min="0" max="100" value="50" />
          <button class="btn" id="btnSetVol">Set</button>
        </div>
      </div>

      <!-- File Transfer info (shown when feature is OFF) -->
      <div id="ftInfoBlock" class="card" style="background:#0f1216">
        <h2>File Transfer</h2>
        <p class="small muted" style="margin-top:6px">
          To enable the file transfer feature, select it from the Advanced menu in the upper right corner.
          This feature will enable you to upload MP3 files directly as well as upload files longer than 30 seconds.
        </p>
      </div>
      <!-- File transfer (advanced) -->
      <div class="spacer"></div>
      <div id="advFTBlock" class="card hidden" style="background:#0f1216">
        <h2>File Transfer</h2>
        <div class="small muted" style="margin:6px 0 10px">
          Once the file has been uploaded you will be able to modify its settings (either here or in the official app).
        </div>
        <label>Choose file</label>
        <input id="fileInput" type="file" />
        <label class="small checkline mt-8">
          <input id="chkConvert" type="checkbox"> Convert to device format (MP3, 8 kHz mono)
        </label>
        <div id="convertOpts" class="row hidden" style="align-items:center">
          <select id="mp3Kbps" aria-label="MP3 bitrate">
            <option value="16">16 kbps</option>
            <option value="24">24 kbps</option>
            <option value="32" selected>32 kbps</option>
          </select>
          <span class="small muted">Output replaces selected file before upload.</span>
        </div>


        <label>Device filename (UTF-16LE; ‚Äú5C55‚Äù prefix auto)</label>
        <input id="fileName" placeholder="test2_Robot.mp3" />
        <div class="actions">
          <button class="btn primary" id="btnSendFile">Send to Device</button>
          <button class="btn danger" id="btnCancelFile" disabled>Cancel</button>
        </div>
        <div class="capsule">
          <div>Progress: <span id="progText">0 / 0</span></div>
          <div id="progPct">0%</div>
        </div>
        <div class="progress"><div id="progBar" class="bar"></div></div>
        <div class="small muted" id="capLine" style="margin-top:8px">Remaining capacity: ‚Äî</div>
      </div>

    </section>

    <!-- MIDDLE COL: Text to Speech (bottom) -->
    <section class="card area-empty">
      <h2>Misc Speech Addons</h2>
      <div class="subcard upcoming" aria-disabled="true">
          <div class="subcard-head"><strong>Upcoming:</strong> Text To Speech
        </div>
        <form id="ttsForm" onsubmit="return false;">
        <label for="ttsText">Text</label>
        <textarea id="ttsText" rows="5" placeholder="Type what Skelly should say..."></textarea>

        <div class="actions">
          <button class="btn primary" id="btnSendTTS">Send</button>
        </div>

        <div class="small muted">TODO: Add effects...</div>
      </form>
        </div>
      
      <div class="spacer"></div>
        <div class="subcard upcoming" aria-disabled="true">
          <div class="subcard-head">
            <strong>Upcoming:</strong> Record custom audio / forward device audio
          </div>
          <p class="small muted">
            Capture mic audio or forward system audio directly to Skelly (work in progress).
          </p>
          <div class="row">
            <button class="btn" disabled>Record from Microphone</button>
            <button class="btn" disabled>Forward Device Audio</button>
          </div>
        </div>

    </section>


    <!-- LEFT COL: Appearance (under Device) -->
    <section class="card area-appearance">
      <h2>Appearance (Live)</h2>

      <label>Target</label>
      <select id="targetSelect" aria-label="Target channel"></select>
      <!-- Movement (Live) -->
      <div class="spacer"></div>
      <label>Movement</label>
      <div id="liveMove" class="move-grid">
        <button class="iconToggle" data-part="all"   title="All">
          <img src="images/icon_action1_se.png" alt="All" />
        </button>
        <button class="iconToggle" data-part="head"  title="Head">
          <img src="images/icon_action2_se.png" alt="Head" />
        </button>
        <button class="iconToggle" data-part="arm"   title="Arm">
          <img src="images/icon_action3_se.png" alt="Arm" />
        </button>
        <button class="iconToggle" data-part="torso" title="Torso">
          <img src="images/icon_action4_se.png" alt="Torso" />
        </button>
      </div>
      <button class="btn" id="applyLiveMove">Apply Movement</button>

      <div class="spacer"></div>
      <div>
        <label>Lighting Type</label>
        <div class="row">
          <select id="lightMode" aria-label="Lighting type">
            <option value="1">Static</option>
            <option value="2">Strobe</option>
            <option value="3">Pulsing</option>
          </select>
          <button class="btn" id="btnSetMode">Apply Mode</button>
        </div>
      </div>

      <div class="spacer"></div>
      <div id="speedBlock" class="hidden">
        <label>Speed (0‚Äì255)</label>
        <div class="row">
          <input id="speedRange" type="range" min="0" max="255" value="0" />
          <input id="speed" type="number" min="0" max="255" value="0" />
          <button class="btn" id="btnSetSpeed">Set Speed</button>
        </div>
      </div>

      <div class="spacer"></div>
      <div>
        <label>Brightness (0‚Äì255)</label>
        <div class="row">
          <input id="brightnessRange" type="range" min="0" max="255" value="200" />
          <input id="brightness" type="number" min="0" max="255" value="200" />
          <button class="btn" id="btnSetBrightness">Set Brightness</button>
        </div>
      </div>

      <div class="spacer"></div>
      <div>
        <label>Color</label>
        <div class="row">
          <input id="colorPick" type="color" value="#ff0000" />
          <input id="r" type="number" min="0" max="255" value="255" />
          <input id="g" type="number" min="0" max="255" value="0" />
          <input id="b" type="number" min="0" max="255" value="0" />
          <button class="btn" id="btnSetRGB">Set Color</button>
        </div>
        <!-- Cycle All Colors (LIVE) -->
        <div class="actions" id="colorCycleLive">
          <button class="iconToggle" id="btnColorCycleLive" title="Cycle all colors (All channels)">
            <img src="images/icon_light_cycle_no.png" alt="Cycle colors" />
          </button>
          <span class="small muted">Cycles all colors on <strong>All channels</strong></span>
        </div>

      <div class="spacer"></div>
      <div>
        <label>Eyes (F9 ‚Äî optional per-file)</label>
        <div id="apEyeGrid" class="eye-grid" aria-label="Choose eye icon"></div>
        <div class="row">
          <input id="apCluster" type="number" min="0" step="1" placeholder="Cluster (optional)">
          <input id="apName" placeholder="Filename (optional)">
        </div>
        <div class="actions">
          <button class="btn" id="apSetEye">Set Eye (F9)</button>
        </div>
      </div>
    </section>

    <!-- RIGHT COL: Status, Log, Files -->
    
    <section class="card area-log">
      <h2>Log</h2>
      <div class="actions">
        <button class="btn xs" id="btnClearLog">Clear</button>
        <label class="small checkline">
          <input type="checkbox" id="chkAutoscroll" checked /> Autoscroll
        </label>
      </div>
      <div id="log" class="log" aria-live="polite"></div>
      <div class="small muted">Notifications parsed for FEDC/BBE1/E5/E6/E0/CC/C0/C1/C2/C3/C4/C5/C6/C7/C8/D2/D1/D0.</div>
    </section>

    <section class="card area-files">
      <h2>Files on Device</h2>
      <div class="actions">
        <button class="btn" id="btnRefreshFiles">Refresh List</button>
        <span class="small muted" id="filesSummary">‚Äî</span>
        <input id="filesFilter" placeholder="Filter by name‚Ä¶" style="max-width:200px" />
      </div>
      <div class="spacer"></div>
      <div class="tablewrap">
        <table id="filesTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Cluster</th>
              <th>Name</th>
              <th>Attr</th>
              <th>Eye</th>
              <th>DB</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
    <section class="card area-status">
      <h2>Current Status</h2>
      <div class="row small" style="gap:12px; flex-wrap:wrap">
        <div style="flex:1 1 180px"><div class="muted">Device Name</div><div id="statName">‚Äî</div></div>
        <div style="flex:1 1 120px"><div class="muted">Show Mode</div><div id="statShowMode">‚Äî</div></div>
        <div style="flex:1 1 160px"><div class="muted">Channels</div><div id="statChannels">‚Äî</div></div>
        <div style="flex:1 1 160px"><div class="muted">Classic BT Name</div><div id="statBtName">‚Äî</div></div>
        <div style="flex:1 1 120px"><div class="muted">Volume</div><div id="statVolume">‚Äî</div></div>
        <div style="flex:1 1 220px"><div class="muted">Capacity</div><div id="statCapacity">‚Äî</div></div>
        <div style="flex:1 1 220px" class="row">
          <div>
            <div class="muted">Live Eye</div>
            <div id="statEyeWrap">
              <img id="statEye" class="eye-thumb" alt="eye" style="display:none" />
              <span id="statEyeText">‚Äî</span>
            </div>
          </div>
          <div>
            <div class="muted">Live Action</div><div id="statAction">‚Äî</div>
          </div>
        </div>
      </div>
    </section>

  </div>

  <footer>
    <span class="muted">Tip: Requires Chrome/Edge (desktop or Android) over HTTPS. Web Bluetooth isn‚Äôt supported in Firefox on desktop.</span>
    <span class="muted"> Source code: 
  <a href="https://github.com/tinkertims/tinkertims.github.io" target="_blank" rel="noopener">
    github.com/tinkertims/tinkertims.github.io
  </a></span>
  </footer>

  <!-- Load the app code -->
  <script src="app.js"></script>
  <script type="module" src="./js/piper-tts-alan.js"></script>
</body>
</html>
